datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["bookings", "events"]
}

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
  previewFeatures = ["multiSchema"]
}

// ── Bookings Schema ─────────────────────────────────────────────────────────

model Booking {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  eventId        String    @map("event_id") @db.Uuid
  idempotencyKey String?   @unique @map("idempotency_key") @db.VarChar(255)
  status         String    @default("held") @db.VarChar(20)
  totalAmount    Decimal   @default(0) @map("total_amount") @db.Decimal(10, 2)
  promoCode      String?   @map("promo_code") @db.VarChar(50)
  discountAmount Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  holdExpiresAt  DateTime? @map("hold_expires_at") @db.Timestamptz()
  version        Int       @default(0)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  tickets        Ticket[]

  @@map("bookings")
  @@schema("bookings")
}

model Ticket {
  id           String   @id @default(uuid()) @db.Uuid
  bookingId    String   @map("booking_id") @db.Uuid
  ticketTierId String   @map("ticket_tier_id") @db.Uuid
  seatId       String?  @map("seat_id") @db.Uuid
  qrCode       String   @unique @map("qr_code") @db.VarChar(255)
  status       String   @default("held") @db.VarChar(20)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()
  booking      Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("tickets")
  @@schema("bookings")
}

// ── Read-only: Ticket Tiers from events schema (for inventory checks) ───────

model TicketTier {
  id            String  @id @db.Uuid
  eventId       String  @map("event_id") @db.Uuid
  name          String  @db.VarChar(100)
  price         Decimal @db.Decimal(10, 2)
  quantityTotal Int     @map("quantity_total")
  quantitySold  Int     @default(0) @map("quantity_sold")
  quantityHeld  Int     @default(0) @map("quantity_held")
  version       Int     @default(0)

  @@map("ticket_tiers")
  @@schema("events")
}
